<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DeepNet Social ‚Äî Persistent Posts & Comments</title>
  <style>
    /* (Your original theme, slightly simplified for readability) */
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:#18191a;color:#e4e6ea;line-height:1.34}
    .login-modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:2000}
    .login-content{background:#242526;border-radius:12px;padding:28px;width:420px;max-width:92%;position:relative}
    .modal-close{position:absolute;right:18px;top:14px;font-size:22px;background:none;border:none;color:#b0b3b8;cursor:pointer}
    .modal-close:hover{color:#fff}
    .auth-tabs{display:flex;margin-bottom:16px;background:#3a3b3c;border-radius:8px;padding:4px}
    .auth-tab{flex:1;padding:10px;border-radius:6px;border:none;background:transparent;color:#b0b3b8;font-weight:600;cursor:pointer}
    .auth-tab.active{background:#1877f2;color:#fff}
    .form-input{width:100%;padding:12px;border-radius:8px;border:1px solid #3e4042;background:#3a3b3c;color:#e4e6ea;margin-bottom:12px}
    .auth-btn{width:100%;padding:12px;border-radius:8px;border:none;background:#1877f2;color:white;font-weight:700;cursor:pointer}
    .auth-message{margin-top:12px;padding:8px;border-radius:6px;text-align:center;font-size:14px}
    .auth-message.success{background:rgba(24,119,242,.12);color:#1877f2}
    .auth-message.error{background:rgba(244,67,54,.12);color:#f44336}
    header{position:fixed;inset-inline:0;top:0;height:60px;background:#242526;border-bottom:1px solid #3e4042;z-index:1000}
    .header-content{max-width:1200px;margin:0 auto;height:100%;display:flex;align-items:center;justify-content:space-between;padding:0 16px}
    .logo{display:flex;gap:8px;align-items:center;color:#1877f2;font-weight:700;font-size:20px}
    .search-input{width:320px;padding:10px;border-radius:9999px;background:#3a3b3c;border:none;color:#e4e6ea}
    .header-actions{display:flex;gap:8px;align-items:center}
    .icon-btn{width:40px;height:40px;border-radius:50%;background:#3a3b3c;border:none;color:#e4e6ea;cursor:pointer}
    .user-avatar{width:36px;height:36px;border-radius:50%;object-fit:cover}
    .logout-btn{background:#e74c3c;color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    .main-container{max-width:1200px;margin:80px auto 60px;display:flex;gap:20px;padding:0 16px}
    .left-sidebar,.right-sidebar{width:260px;position:sticky;top:100px;height:calc(100vh - 140px);overflow:auto}
    .main-feed{flex:1;max-width:640px}
    .card{background:#242526;border-radius:8px;padding:16px;margin-bottom:16px;border:1px solid #3e4042}
    .composer-input{width:100%;min-height:56px;padding:12px;border-radius:20px;border:none;background:#3a3b3c;color:#e4e6ea;resize:vertical;font-family:inherit}
    .post-btn{background:#1877f2;color:white;border:none;padding:8px 18px;border-radius:8px;cursor:pointer}
    .post{margin-bottom:16px}
    .post-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .post-author-info{display:flex;align-items:center;gap:10px}
    .post-author{font-weight:700}
    .post-time{color:#b0b3b8;font-size:13px}
    .post-content{margin-bottom:12px;word-wrap:break-word}
    .post-actions{display:flex;gap:8px}
    .post-action{flex:1;padding:8px;border-radius:8px;background:transparent;border:none;color:#b0b3b8;cursor:pointer;font-weight:700}
    .post-action.liked{color:#1877f2}
    .comments-list{margin-top:10px;padding-top:8px;border-top:1px solid #3e4042}
    .comment-item{padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.02)}
    .comment-meta{font-size:13px;color:#b0b3b8;margin-bottom:6px}
    .comment-text{color:#e4e6ea}
    .comment-form{display:flex;gap:8px;margin-top:8px}
    .comment-input{flex:1;padding:8px;border-radius:8px;border:1px solid #3e4042;background:#2f3132;color:#e4e6ea}
    .comment-btn{background:#1877f2;color:white;border:none;padding:8px 12px;border-radius:8px}
    .notification{position:fixed;right:20px;top:80px;background:#1877f2;color:#fff;padding:10px 14px;border-radius:8px;transform:translateX(120%);opacity:0;transition:all .25s}
    .notification.show{transform:translateX(0);opacity:1}
    @media (max-width:1024px){.left-sidebar,.right-sidebar{display:none}.main-feed{max-width:none}}
  </style>
</head>
<body>
  <!-- Login Modal -->
  <div id="loginModal" class="login-modal" aria-hidden="false">
    <div class="login-content" role="dialog" aria-labelledby="authTitle">
      <button class="modal-close" onclick="closeModal()" aria-label="Close">‚úï</button>
      <h2 id="authTitle" style="color:#fff;margin-bottom:8px">üß† DeepNet Social</h2>
      <p style="color:#b0b3b8;margin-bottom:16px">Connect with AI researchers worldwide</p>

      <div class="auth-tabs" role="tablist">
        <button class="auth-tab active" onclick="switchAuthTab('login')" id="tabLogin">Login</button>
        <button class="auth-tab" onclick="switchAuthTab('signup')" id="tabSignup">Sign Up</button>
      </div>

      <form id="loginForm" class="auth-form" aria-label="Login form">
        <input class="form-input" name="email" type="email" placeholder="Email address" required />
        <input class="form-input" name="password" type="password" placeholder="Password" required />
        <button class="auth-btn" type="submit">Log In</button>
        <div id="loginMessage" class="auth-message" aria-live="polite"></div>
      </form>

      <form id="signupForm" class="auth-form hidden" aria-label="Signup form">
        <input class="form-input" name="email" type="email" placeholder="Email address" required />
        <input class="form-input" name="password" type="password" placeholder="Create password" minlength="6" required />
        <button class="auth-btn" type="submit">Sign Up</button>
        <div id="signupMessage" class="auth-message" aria-live="polite"></div>
      </form>
    </div>
  </div>

  <div id="notification" class="notification" role="status" aria-live="polite"></div>

  <!-- Main App -->
  <div id="app" class="hidden" aria-hidden="true">
    <header>
      <div class="header-content">
        <div class="logo"><span>üß†</span> DeepNet Social</div>

        <input class="search-input" id="searchInput" placeholder="Search posts, users, topics..." />

        <div class="header-actions">
          <button class="icon-btn" title="Notifications">üîî</button>
          <button class="icon-btn" title="Messages">üí¨</button>
          <img id="userAvatar" class="user-avatar" src="https://i.pravatar.cc/40?u=guest" alt="Avatar" />
          <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
      </div>
    </header>

    <main class="main-container" role="main">
      <aside class="left-sidebar" aria-label="Left sidebar">
        <div style="padding:8px 0 18px">
          <img id="sidebarAvatar" src="https://i.pravatar.cc/40?u=guest" style="width:56px;height:56px;border-radius:50%" alt="profile" />
          <div id="profileName" style="margin-top:8px;font-weight:700">Your Profile</div>
        </div>
        <!-- Other links... -->
      </aside>

      <section class="main-feed" aria-label="Feed">
        <div class="card post-composer" role="region" aria-label="Post composer">
          <div style="display:flex;gap:12px;align-items:flex-start">
            <img id="composerAvatar" src="https://i.pravatar.cc/40?u=guest" class="user-avatar" alt="You" />
            <textarea id="postInput" class="composer-input" placeholder="Share your research insights..." rows="3"></textarea>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
            <div style="display:flex;gap:8px">
              <button class="composer-btn">üìù Text</button>
              <button class="composer-btn">üíª Code</button>
              <button class="composer-btn">üìÑ Paper</button>
              <button class="composer-btn">üìä Poll</button>
            </div>
            <button id="postButton" class="post-btn">Post</button>
          </div>
        </div>

        <div id="postsContainer" aria-live="polite"></div>
      </section>

      <aside class="right-sidebar" aria-label="Right sidebar">
        <div class="card sidebar-section">
          <div style="font-weight:700;margin-bottom:8px">Trending in AI</div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <div class="trending-item"><span class="trending-hash">#</span> MachineLearning</div>
            <div class="trending-item"><span class="trending-hash">#</span> NeurIPS2025</div>
            <div class="trending-item"><span class="trending-hash">#</span> ComputerVision</div>
          </div>
        </div>

        <div class="card sidebar-section">
          <div style="font-weight:700;margin-bottom:8px">Suggested Connections</div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <div class="suggested-user">
              <div style="display:flex;gap:8px;align-items:center">
                <img src="https://i.pravatar.cc/40?u=john" class="user-avatar" alt="John" />
                <div><div class="suggested-name">Dr. John Smith</div><div class="suggested-field">Computer Vision</div></div>
              </div>
              <button class="follow-btn">Follow</button>
            </div>
            <div class="suggested-user">
              <div style="display:flex;gap:8px;align-items:center">
                <img src="https://i.pravatar.cc/40?u=lisa" class="user-avatar" alt="Lisa" />
                <div><div class="suggested-name">Prof. Lisa Wang</div><div class="suggested-field">NLP</div></div>
              </div>
              <button class="follow-btn">Follow</button>
            </div>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <!-- Firebase + App Script -->
  <script type="module">
    // -----------------------------
    // Imports (modular Firebase v11)
    // -----------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      doc,
      setDoc,
      getDoc,
      deleteDoc,
      updateDoc,
      onSnapshot,
      query,
      orderBy,
      serverTimestamp,
      increment
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // -----------------------------
    // Firebase config ‚Äî use your own project values
    // -----------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyBytov9p2TGFudvnwQZ1hSi5f9oXaSKDAQ",
      authDomain: "deepnet-social-backend.firebaseapp.com",
      projectId: "deepnet-social-backend",
      storageBucket: "deepnet-social-backend.firebasestorage.app",
      messagingSenderId: "689173633913",
      appId: "1:689173633913:web:b5290dc64ea8fd2b2f2da8",
      measurementId: "G-B1ENWRY6JK"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch (e) { /* Analytics may fail in file:// mode */ }
    const auth = getAuth(app);
    const db = getFirestore(app);

    // -----------------------------
    // UI references
    // -----------------------------
    const loginModal = document.getElementById('loginModal');
    const appDiv = document.getElementById('app');
    const userAvatar = document.getElementById('userAvatar');
    const sidebarAvatar = document.getElementById('sidebarAvatar');
    const composerAvatar = document.getElementById('composerAvatar');
    const profileName = document.getElementById('profileName');
    const postInput = document.getElementById('postInput');
    const postButton = document.getElementById('postButton');
    const postsContainer = document.getElementById('postsContainer');
    const notification = document.getElementById('notification');
    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    const loginMessage = document.getElementById('loginMessage');
    const signupMessage = document.getElementById('signupMessage');

    // Keep reference to posts snapshot unsubscribe
    let postsUnsub = null;
    // Map of comment unsubscribers per post
    const commentUnsubs = new Map();

    // -----------------------------
    // Helper: notification
    // -----------------------------
    function showNotification(msg, timeout = 2500) {
      notification.textContent = msg;
      notification.classList.add('show');
      setTimeout(() => notification.classList.remove('show'), timeout);
    }

    // -----------------------------
    // Auth UI: tab switching + modal close
    // -----------------------------
    window.switchAuthTab = function(tab) {
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      if (tab === 'login') {
        document.getElementById('loginForm').classList.remove('hidden');
        document.getElementById('signupForm').classList.add('hidden');
        document.getElementById('tabLogin').classList.add('active');
      } else {
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('signupForm').classList.remove('hidden');
        document.getElementById('tabSignup').classList.add('active');
      }
    };

    window.closeModal = function() {
      loginModal.classList.add('hidden');
    };

    // -----------------------------
    // Signup & Login handlers
    // -----------------------------
    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      signupMessage.textContent = '';
      const email = e.target.email.value.trim();
      const password = e.target.password.value;
      try {
        const userCred = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCred.user;
        // Save basic profile in Firestore users collection
        const displayName = email.split('@')[0];
        await setDoc(doc(db, 'users', user.uid), {
          email: user.email,
          displayName,
          avatarUrl: `https://i.pravatar.cc/40?u=${user.uid}`,
          createdAt: serverTimestamp()
        }, { merge: true });
        // also update auth profile displayName
        await updateProfile(user, { displayName });
        signupMessage.className = 'auth-message success';
        signupMessage.textContent = '‚úÖ Account created successfully!';
        e.target.reset();
        setTimeout(() => { loginModal.classList.add('hidden'); }, 800);
      } catch (err) {
        signupMessage.className = 'auth-message error';
        signupMessage.textContent = `‚ùå ${err.message}`;
      }
    });

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginMessage.textContent = '';
      const email = e.target.email.value.trim();
      const password = e.target.password.value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
        loginMessage.className = 'auth-message success';
        loginMessage.textContent = '‚úÖ Login successful!';
        e.target.reset();
        setTimeout(() => { loginModal.classList.add('hidden'); }, 600);
      } catch (err) {
        loginMessage.className = 'auth-message error';
        loginMessage.textContent = `‚ùå ${err.message}`;
      }
    });

    // -----------------------------
    // Logout
    // -----------------------------
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        await signOut(auth);
        showNotification('Logged out');
      } catch (err) {
        showNotification('Logout failed: ' + err.message);
      }
    });

    // -----------------------------
    // Posts: real-time listener
    // -----------------------------
    function startPostsListener() {
      if (postsUnsub) { postsUnsub(); postsUnsub = null; }
      const postsRef = collection(db, 'posts');
      const q = query(postsRef, orderBy('createdAt', 'desc'));
      postsUnsub = onSnapshot(q, (snap) => {
        // render posts
        postsContainer.innerHTML = '';
        snap.forEach(docSnap => {
          const data = docSnap.data();
          const id = docSnap.id;
          renderPost(id, data);
        });
      }, (err) => {
        console.error('posts snapshot error', err);
      });
    }

    // -----------------------------
    // Render a single post DOM
    // -----------------------------
    function renderPost(postId, data) {
      const el = document.createElement('div');
      el.className = 'card post';
      const createdAtText = data.createdAt ? (data.createdAt.toDate ? data.createdAt.toDate().toLocaleString() : new Date(data.createdAt).toLocaleString()) : 'Just now';
      const authorName = data.authorName || (data.authorEmail ? data.authorEmail.split('@')[0] : 'Anonymous');
      const avatarUrl = data.avatarUrl || `https://i.pravatar.cc/40?u=${data.authorId || 'anon'}`;
      const likeCount = data.likeCount || 0;
      const commentCount = data.commentCount || 0;

      el.innerHTML = `
        <div class="post-header">
          <div class="post-author-info">
            <img src="${avatarUrl}" class="user-avatar" alt="${authorName}" />
            <div>
              <div class="post-author">${escapeHtml(authorName)}</div>
              <div class="post-time">${escapeHtml(createdAtText)}</div>
            </div>
          </div>
          <div>
            ${auth.currentUser && auth.currentUser.uid === data.authorId ? `<button class="post-menu" title="Delete">‚ãØ</button>` : ''}
          </div>
        </div>
        <div class="post-content">${escapeHtml(data.content).replace(/\n/g,'<br>')}</div>
        <div class="post-stats">
          <span class="likes-count">${likeCount} reactions ‚Ä¢ ${commentCount} comments</span>
          <span class="shares-count">0 shares</span>
        </div>
        <div class="post-actions">
          <button class="post-action like-btn">üëç Like</button>
          <button class="post-action comment-btn">üí¨ Comment</button>
          <button class="post-action share-btn">‚ÜóÔ∏è Share</button>
        </div>
        <div class="comments-list hidden" aria-hidden="true"></div>
      `;

      // attach listeners
      const likeBtn = el.querySelector('.like-btn');
      const commentBtn = el.querySelector('.comment-btn');
      const shareBtn = el.querySelector('.share-btn');
      const commentsList = el.querySelector('.comments-list');

      // determine if current user already liked (async)
      if (auth.currentUser) {
        const likeDocRef = doc(db, 'posts', postId, 'likes', auth.currentUser.uid);
        getDoc(likeDocRef).then(snapshot => {
          if (snapshot.exists()) likeBtn.classList.add('liked');
        }).catch(e => console.warn('like check failed', e));
      }

      likeBtn.addEventListener('click', async () => {
        if (!auth.currentUser) { showNotification('Please log in to like posts'); return; }
        try {
          const likeDocRef = doc(db, 'posts', postId, 'likes', auth.currentUser.uid);
          const likeDoc = await getDoc(likeDocRef);
          const postRef = doc(db, 'posts', postId);
          if (likeDoc.exists()) {
            await deleteDoc(likeDocRef);
            await updateDoc(postRef, { likeCount: increment(-1) });
            likeBtn.classList.remove('liked');
          } else {
            await setDoc(likeDocRef, { uid: auth.currentUser.uid, createdAt: serverTimestamp() });
            await updateDoc(postRef, { likeCount: increment(1) });
            likeBtn.classList.add('liked');
          }
        } catch (err) {
          console.error('toggle like failed', err);
          showNotification('Failed to toggle like: ' + err.message);
        }
      });

      commentBtn.addEventListener('click', () => {
        toggleCommentsArea(postId, commentsList, !commentsList.classList.contains('hidden'));
      });

      shareBtn.addEventListener('click', () => {
        showNotification('Post shared! üîÑ');
        // share count not implemented but could update DB similarly
      });

      // insert at end
      postsContainer.appendChild(el);
    }

    // -----------------------------
    // Comments area toggling + realtime comments subscription
    // -----------------------------
    function toggleCommentsArea(postId, commentsEl, opening) {
      if (!opening) {
        // open: subscribe comments and render form
        commentsEl.classList.remove('hidden');
        commentsEl.innerHTML = `<div style="margin:8px 0 12px;font-weight:600;color:#b0b3b8">Comments</div>
                                <div class="comments-list-items"></div>
                                <div class="comment-form">
                                  <input class="comment-input" placeholder="Write a comment..." />
                                  <button class="comment-btn">Post</button>
                                </div>`;
        commentsEl.setAttribute('aria-hidden', 'false');

        const itemsWrap = commentsEl.querySelector('.comments-list-items');
        const commentInput = commentsEl.querySelector('.comment-input');
        const commentBtn = commentsEl.querySelector('.comment-btn');

        // attach click
        commentBtn.addEventListener('click', async () => {
          const text = commentInput.value.trim();
          if (!text) { showNotification('Please write a comment'); return; }
          if (!auth.currentUser) { showNotification('Please login to comment'); return; }
          try {
            const commentsCol = collection(db, 'posts', postId, 'comments');
            await addDoc(commentsCol, {
              authorId: auth.currentUser.uid,
              authorName: auth.currentUser.displayName || auth.currentUser.email.split('@')[0],
              content: text,
              createdAt: serverTimestamp()
            });
            // increment commentCount on post
            const postRef = doc(db, 'posts', postId);
            await updateDoc(postRef, { commentCount: increment(1) });
            commentInput.value = '';
          } catch (err) {
            console.error('add comment failed', err);
            showNotification('Failed to add comment: ' + err.message);
          }
        });

        // subscribe to comments
        const commentsQuery = query(collection(db, 'posts', postId, 'comments'), orderBy('createdAt', 'asc'));
        const unsub = onSnapshot(commentsQuery, (snap) => {
          itemsWrap.innerHTML = '';
          snap.forEach(cDoc => {
            const c = cDoc.data();
            const created = c.createdAt ? (c.createdAt.toDate ? c.createdAt.toDate().toLocaleString() : new Date(c.createdAt).toLocaleString()) : 'Just now';
            const div = document.createElement('div');
            div.className = 'comment-item';
            div.innerHTML = `<div class="comment-meta"><strong>${escapeHtml(c.authorName)}</strong> ‚Ä¢ <span>${escapeHtml(created)}</span></div>
                             <div class="comment-text">${escapeHtml(c.content)}</div>`;
            itemsWrap.appendChild(div);
          });
        });
        // store unsubscribe for cleanup if needed
        commentUnsubs.set(postId, unsub);
      } else {
        // close: unsubscribe and hide
        if (commentUnsubs.has(postId)) {
          commentUnsubs.get(postId)();
          commentUnsubs.delete(postId);
        }
        commentsEl.classList.add('hidden');
        commentsEl.setAttribute('aria-hidden', 'true');
      }
    }

    // -----------------------------
    // Create post (write to Firestore)
    // -----------------------------
    document.getElementById('postButton').addEventListener('click', async () => {
      const content = postInput.value.trim();
      if (!content) {
        showNotification('Please enter some content for your post');
        return;
      }
      if (!auth.currentUser) {
        showNotification('Please log in to create a post');
        return;
      }
      postButton.disabled = true;
      postButton.textContent = 'Posting...';
      try {
        const user = auth.currentUser;
        await addDoc(collection(db, 'posts'), {
          content,
          authorId: user.uid,
          authorEmail: user.email,
          authorName: user.displayName || user.email.split('@')[0],
          avatarUrl: user.photoURL || `https://i.pravatar.cc/40?u=${user.uid}`,
          likeCount: 0,
          commentCount: 0,
          createdAt: serverTimestamp()
        });
        postInput.value = '';
        showNotification('Post created ‚úÖ');
      } catch (err) {
        console.error('create post failed', err);
        showNotification('Failed to create post: ' + err.message);
      } finally {
        postButton.disabled = false;
        postButton.textContent = 'Post';
      }
    });

    // Also allow Ctrl+Enter for posting
    postInput.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'Enter') { document.getElementById('postButton').click(); }
    });

    // -----------------------------
    // Utility: escape HTML to prevent XSS
    // -----------------------------
    function escapeHtml(s) {
      if (!s && s !== 0) return '';
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // -----------------------------
    // Start listening for posts right away (public feed)
    // -----------------------------
    startPostsListener();

    // -----------------------------
    // Auth state handling - update UI and authorizations
    // -----------------------------
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // update UI
        loginModal.classList.add('hidden');
        appDiv.classList.remove('hidden');
        appDiv.setAttribute('aria-hidden', 'false');
        const avatarUrl = user.photoURL || `https://i.pravatar.cc/40?u=${user.uid}`;
        userAvatar.src = avatarUrl;
        sidebarAvatar.src = avatarUrl;
        composerAvatar.src = avatarUrl;
        profileName.textContent = user.displayName || user.email.split('@')[0];
        showNotification(`Welcome ${profileName.textContent}`, 1600);
      } else {
        // show login modal
        loginModal.classList.remove('hidden');
        appDiv.classList.add('hidden');
        appDiv.setAttribute('aria-hidden', 'true');
        userAvatar.src = 'https://i.pravatar.cc/40?u=guest';
        sidebarAvatar.src = 'https://i.pravatar.cc/40?u=guest';
        composerAvatar.src = 'https://i.pravatar.cc/40?u=guest';
        profileName.textContent = 'Your Profile';
      }
    });

    // Clean up comment listeners on unload
    window.addEventListener('beforeunload', () => {
      if (postsUnsub) postsUnsub();
      commentUnsubs.forEach(unsub => unsub());
      commentUnsubs.clear();
    });

    console.log('DeepNet Social (Firestore-backed) loaded');
  </script>
</body>
</html>
