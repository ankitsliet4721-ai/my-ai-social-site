<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DeepNet Social</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Login Modal -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <h2>Welcome to DeepNet Social</h2>
      <div>
        <button onclick="switchAuthTab('login')" id="loginTab" class="active">Login</button>
        <button onclick="switchAuthTab('signup')" id="signupTab">Sign Up</button>
      </div>
      <form id="loginForm">
        <input type="email" id="loginEmail" placeholder="Email" required />
        <input type="password" id="loginPassword" placeholder="Password" required />
        <button type="submit">Login</button>
        <p id="loginMessage"></p>
      </form>
      <form id="signupForm" class="hidden">
        <input type="email" id="signupEmail" placeholder="Email" required />
        <input type="password" id="signupPassword" placeholder="Password" required />
        <button type="submit">Sign Up</button>
        <p id="signupMessage"></p>
      </form>
    </div>
  </div>

  <!-- App -->
  <div id="app" class="hidden">
    <header>
      <h1>DeepNet Social</h1>
      <button onclick="logoutUser()">Logout</button>
    </header>

    <!-- Post composer -->
    <div class="post-composer">
      <textarea id="postContent" placeholder="Share your thoughts..."></textarea>
      <button onclick="createPost()">Post</button>
    </div>

    <!-- Posts -->
    <div id="postsContainer"></div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBytov9p2TGFudvnwQZ1hSi5f9oXaSKDAQ",
      authDomain: "deepnet-social-backend.firebaseapp.com",
      projectId: "deepnet-social-backend",
      storageBucket: "deepnet-social-backend.firebasestorage.app",
      messagingSenderId: "689173633913",
      appId: "1:689173633913:web:b5290dc64ea8fd2b2f2da8",
      measurementId: "G-B1ENWRY6JK"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // üîπ UI Functions
    function switchAuthTab(tab) {
      document.getElementById("loginForm").classList.toggle("hidden", tab !== "login");
      document.getElementById("signupForm").classList.toggle("hidden", tab !== "signup");
      document.getElementById("loginTab").classList.toggle("active", tab === "login");
      document.getElementById("signupTab").classList.toggle("active", tab === "signup");
    }
    function closeLoginModal(){ document.getElementById("loginModal").style.display="none";}
    function openLoginModal(){ document.getElementById("loginModal").style.display="block";}
    function showApp(){ document.getElementById("app").classList.remove("hidden"); closeLoginModal();}
    function logoutUser(){ auth.signOut(); }

    // üîπ Authentication
    document.getElementById("signupForm").addEventListener("submit", e => {
      e.preventDefault();
      const email = document.getElementById("signupEmail").value;
      const password = document.getElementById("signupPassword").value;
      auth.createUserWithEmailAndPassword(email,password).catch(err=>{
        document.getElementById("signupMessage").textContent=err.message;
      });
    });
    document.getElementById("loginForm").addEventListener("submit", e => {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      auth.signInWithEmailAndPassword(email,password).catch(err=>{
        document.getElementById("loginMessage").textContent=err.message;
      });
    });
    auth.onAuthStateChanged(user=>{
      if(user){ showApp(); listenPosts(); }
      else{ document.getElementById("app").classList.add("hidden"); openLoginModal();}
    });

    // üîπ Create Post (Firestore)
    async function createPost(){
      const user = auth.currentUser;
      if(!user) return alert("Login first!");
      const content = document.getElementById("postContent").value.trim();
      if(!content) return;
      await db.collection("posts").add({
        content,
        authorId: user.uid,
        authorName: user.email.split("@")[0],
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        likes: 0,
        likedBy: [],
        comments: []
      });
      document.getElementById("postContent").value="";
    }

    // üîπ Listen to Posts in Real Time
    function listenPosts(){
      db.collection("posts").orderBy("createdAt","desc").onSnapshot(snapshot=>{
        const container=document.getElementById("postsContainer");
        container.innerHTML="";
        snapshot.forEach(doc=>{
          const post=doc.data();
          post.id=doc.id;
          container.appendChild(createPostElement(post));
        });
      });
    }

    // üîπ Render Post
    function createPostElement(post){
      const div=document.createElement("div");
      div.className="post";
      const time=post.createdAt?.toDate().toLocaleString()||"just now";
      div.innerHTML=`
        <p><strong>${post.authorName}</strong> <small>${time}</small></p>
        <p>${post.content}</p>
        <button onclick="toggleLike('${post.id}')">üëç ${post.likes||0}</button>
        <div class="comments">
          ${(post.comments||[]).map((c,i)=>`<p><b>${c.author}</b>: ${c.text}</p>`).join("")}
          <input type="text" id="cmt-${post.id}" placeholder="Write a comment..."/>
          <button onclick="addComment('${post.id}')">Comment</button>
        </div>
      `;
      return div;
    }

    // üîπ Like Post
    async function toggleLike(postId){
      const user=auth.currentUser;
      if(!user) return alert("Login first!");
      const ref=db.collection("posts").doc(postId);
      const snap=await ref.get();
      if(!snap.exists) return;
      const data=snap.data();
      let likedBy=data.likedBy||[];
      if(likedBy.includes(user.uid)){
        likedBy=likedBy.filter(id=>id!==user.uid);
      } else {
        likedBy.push(user.uid);
      }
      await ref.update({ likedBy, likes: likedBy.length });
    }

    // üîπ Add Comment
    async function addComment(postId){
      const user=auth.currentUser;
      if(!user) return alert("Login first!");
      const input=document.getElementById("cmt-"+postId);
      const text=input.value.trim();
      if(!text) return;
      const ref=db.collection("posts").doc(postId);
      await ref.update({
        comments: firebase.firestore.FieldValue.arrayUnion({
          userId:user.uid,
          author:user.email.split("@")[0],
          text,
          createdAt:new Date().toISOString()
        })
      });
      input.value="";
    }
  </script>
</body>
</html>
