<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DeepNet Social — Fixed Demo</title>
  <style>
    /* Minimal styling for demo */
    :root{--bg:#0b1117;--card:#0f1720;--muted:#94a3b8;--accent:#238636;color-scheme:dark}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#e6edf3}
    .hidden{display:none}
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.6)}
    .modal-content{width:560px;background:var(--card);border-radius:10px;padding:16px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    .modal-header{display:flex;justify-content:space-between;align-items:center}
    .form-group{margin:10px 0}
    .form-label{display:block;margin-bottom:6px;color:var(--muted);font-size:14px}
    .form-control{width:100%;padding:10px;border-radius:6px;border:1px solid #1f2937;background:#07101a;color:#e6edf3}
    .btn{padding:10px 14px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    .btn--primary{background:var(--accent)}
    .btn--full-width{width:100%}
    .app-container{display:flex;flex-direction:column;min-height:100vh}
    .header{background:#071018;padding:10px 18px;border-bottom:1px solid #0f1923}
    .header-content{display:flex;align-items:center;justify-content:space-between}
    .logo{display:flex;gap:8px;align-items:center}
    .search-input{padding:8px 10px;border-radius:8px;border:1px solid #14202b;background:#071b24;color:#e6edf3}
    .left-sidebar,.right-sidebar{width:220px;padding:16px}
    .feed-container{flex:1;padding:16px}
    .card{background:#07161c;padding:12px;border-radius:10px;margin-bottom:12px}
    .post-composer{display:flex;flex-direction:column}
    .composer-header{display:flex;gap:12px}
    .composer-input{min-height:80px;padding:8px;border-radius:8px;border:1px solid #14202b;background:#071b24;color:#e6edf3}
    .composer-btn{background:transparent;border:1px solid #122635;padding:6px 8px;border-radius:8px;cursor:pointer}
    .composer-btn.active{background:linear-gradient(180deg,#164d34,#0b3b2a);color:#fff}
    .trending-topic{padding:6px 8px;border-radius:6px;background:#06121a;margin:6px 0}
    .suggested-user{display:flex;align-items:center;gap:8px;padding:8px 0}
    .user-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#072226}
    .post{margin-bottom:12px}
    .post-header{display:flex;gap:8px;align-items:center}
    .post-actions{display:flex;gap:8px;margin-top:8px}
    .post-action{background:transparent;border:1px solid #122635;padding:6px 8px;border-radius:8px;cursor:pointer}
    .light-theme{background:#fbfaf8;color:#0b1220}
    .muted{color:var(--muted)}
    .login-hint{color:var(--muted);font-size:13px;margin-top:8px}
  </style>
</head>
<body>
  <!-- Single copy of the UI (duplicate content removed) -->
  <div id="loginModal" class="modal">
    <div class="modal-content" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h2>Welcome to DeepNet Social</h2>
        <button type="button" class="modal-close" id="modalCloseBtn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="auth-tabs">
          <button type="button" class="auth-tab active" id="tabLogin">Login</button>
          <button type="button" class="auth-tab" id="tabSignup">Sign Up</button>
        </div>

        <form id="loginForm" class="auth-form">
          <div class="form-group">
            <label class="form-label" for="loginEmail">Email</label>
            <input type="email" class="form-control" id="loginEmail" placeholder="Enter your email" required />
          </div>
          <div class="form-group">
            <label class="form-label" for="loginPassword">Password</label>
            <input type="password" class="form-control" id="loginPassword" placeholder="Enter password" required />
          </div>
          <button type="submit" class="btn btn--primary btn--full-width">Login</button>
          <div id="loginMessage" class="login-hint"></div>
        </form>

        <form id="signupForm" class="auth-form hidden">
          <div class="form-group">
            <label class="form-label" for="signupEmail">Email</label>
            <input type="email" class="form-control" id="signupEmail" placeholder="Enter your email" required />
          </div>
          <div class="form-group">
            <label class="form-label" for="signupPassword">Password</label>
            <input type="password" class="form-control" id="signupPassword" placeholder="Create a password" minlength="6" required />
          </div>
          <button type="submit" class="btn btn--primary btn--full-width">Sign Up</button>
          <div id="signupMessage" class="login-hint"></div>
        </form>
      </div>
    </div>
  </div>

  <div id="app" class="app-container hidden">
    <header class="header">
      <div class="header-content">
        <div class="logo"><span class="logo-icon">🧠</span><strong>DeepNet Social</strong></div>
        <div class="search-container">
          <input id="searchInput" class="search-input" placeholder="Search posts, users, topics..." />
        </div>
        <div style="display:flex;gap:12px;align-items:center">
          <button id="themeToggle" class="btn">🌙</button>
          <div class="user-avatar" id="currentUserAvatar">👩‍🔬</div>
          <button id="logoutBtn" class="btn">Logout</button>
        </div>
      </div>
    </header>

    <section id="main-content" style="display:flex;gap:12px">
      <aside class="left-sidebar card">
        <ul style="padding:0;margin:0;list-style:none">
          <li><a href="#" class="sidebar-link active" data-filter="all">📰 My Feed</a></li>
          <li><a href="#" class="sidebar-link" data-filter="trending">📈 Trending Research</a></li>
          <li><a href="#" class="sidebar-link" data-filter="communities">👥 AI Communities</a></li>
          <li><a href="#" class="sidebar-link" data-filter="bookmarks">🔖 Bookmarks</a></li>
          <li><a href="#" class="sidebar-link" data-filter="settings">⚙️ Settings</a></li>
        </ul>
      </aside>

      <main class="feed-container">
        <div class="post-composer card">
          <div class="composer-header">
            <div class="user-avatar">👩‍🔬</div>
            <div style="flex:1">
              <textarea id="postContent" class="composer-input" placeholder="Share your research insights..."></textarea>
            </div>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <div>
              <button class="composer-btn active" data-type="text">📝 Text</button>
              <button class="composer-btn" data-type="code">💻 Code</button>
              <button class="composer-btn" data-type="paper">📄 Paper</button>
              <button class="composer-btn" data-type="poll">📊 Poll</button>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <select id="privacySelect" class="form-control" style="width:160px">
                <option value="public">🌍 Public</option>
                <option value="research">🔬 Research Community</option>
                <option value="private">🔒 Private</option>
              </select>
              <button id="createPostBtn" class="btn btn--primary">Post</button>
            </div>
          </div>
        </div>

        <div id="postsContainer" class="posts-container"></div>
      </main>

      <aside class="right-sidebar">
        <div class="sidebar-card card">
          <h3>Trending Topics</h3>
          <div id="trendingTopics" class="trending-topics"></div>
        </div>
        <div class="sidebar-card card">
          <h3>Suggested Connections</h3>
          <div id="suggestedUsers" class="suggested-users"></div>
        </div>
      </aside>
    </section>
  </div>

  <!-- Firebase CDN (v8) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <script>
    /*
      FIX SUMMARY (what I changed in this single-file demo):
       - Removed duplicated HTML blocks (there were two full copies).
       - Encapsulated JS into safe initialization and fixed event handling bugs (togglePostType previously relied on a global "event").
       - appState.currentUser is set on auth state changes so posts show the correct author.
       - Sanitized post content to avoid XSS injection when rendering posts.
       - Replaced inline style coloring with a CSS class for composer active state.
       - Added safer DOM updates and small UI improvements.
       - Kept Firebase config placeholders (use your project's config). Optional: integrate Firestore to persist posts.
    */

    // Replace with your project's config (the example config is from the snippet you provided).
    const firebaseConfig = {
      apiKey: "AIzaSyBytov9p2TGFudvnwQZ1hSi5f9oXaSKDAQ",
      authDomain: "deepnet-social-backend.firebaseapp.com",
      projectId: "deepnet-social-backend",
      storageBucket: "deepnet-social-backend.firebasestorage.app",
      messagingSenderId: "689173633913",
      appId: "1:689173633913:web:b5290dc64ea8fd2b2f2da8",
      measurementId: "G-B1ENWRY6JK"
    };

    firebase.initializeApp(firebaseConfig);
    try { firebase.analytics(); } catch (e) { console.warn('Analytics init failed', e); }
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // App state
    const appState = { currentUser: null, posts: [], currentSection: 'home' };

    // Utility: escape HTML
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // DOM helpers
    const selectors = {
      loginModal: document.getElementById('loginModal'),
      loginForm: document.getElementById('loginForm'),
      signupForm: document.getElementById('signupForm'),
      loginMessage: document.getElementById('loginMessage'),
      signupMessage: document.getElementById('signupMessage'),
      app: document.getElementById('app'),
      postsContainer: document.getElementById('postsContainer'),
      createPostBtn: document.getElementById('createPostBtn'),
      postContent: document.getElementById('postContent'),
      privacySelect: document.getElementById('privacySelect'),
      currentUserAvatar: document.getElementById('currentUserAvatar'),
      modalCloseBtn: document.getElementById('modalCloseBtn')
    };

    // UI controls
    function openLoginModal(){ selectors.loginModal.classList.remove('hidden'); selectors.loginModal.style.display = 'flex'; }
    function closeLoginModal(){ selectors.loginModal.classList.add('hidden'); selectors.loginModal.style.display = 'none'; }
    function showApp(){ selectors.app.classList.remove('hidden'); closeLoginModal(); }
    function hideApp(){ selectors.app.classList.add('hidden'); }

    // Auth flows
    document.getElementById('tabLogin').addEventListener('click', ()=>{ document.getElementById('loginForm').classList.remove('hidden'); document.getElementById('signupForm').classList.add('hidden'); });
    document.getElementById('tabSignup').addEventListener('click', ()=>{ document.getElementById('loginForm').classList.add('hidden'); document.getElementById('signupForm').classList.remove('hidden'); });

    document.getElementById('modalCloseBtn').addEventListener('click', () => { closeLoginModal(); });

    selectors.signupForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      selectors.signupMessage.textContent = '...creating account';

      auth.createUserWithEmailAndPassword(email, password)
        .then(userCredential=>{
          selectors.signupMessage.style.color='lightgreen';
          selectors.signupMessage.textContent = `Account created: ${userCredential.user.email}`;
          // Optionally create a user doc in Firestore
          db.collection('users').doc(userCredential.user.uid).set({ email: userCredential.user.email, createdAt: firebase.firestore.FieldValue.serverTimestamp()}).catch(()=>{});
        })
        .catch(err=>{
          selectors.signupMessage.style.color='salmon';
          selectors.signupMessage.textContent = `Error: ${err.message}`;
        });
    });

    selectors.loginForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      selectors.loginMessage.textContent = '...signing in';

      auth.signInWithEmailAndPassword(email, password)
        .then(userCredential=>{
          selectors.loginMessage.style.color='lightgreen';
          selectors.loginMessage.textContent = `Login successful: ${userCredential.user.email}`;
        })
        .catch(err=>{
          selectors.loginMessage.style.color='salmon';
          selectors.loginMessage.textContent = `Error: ${err.message}`;
        });
    });

    document.getElementById('logoutBtn').addEventListener('click', ()=>{
      auth.signOut().then(()=>{
        appState.currentUser = null;
        hideApp();
        openLoginModal();
        alert('Logged out successfully');
      });
    });

    // Watch auth state
    auth.onAuthStateChanged(user => {
      if(user){
        console.log('User logged in:', user.email);
        appState.currentUser = user;
        selectors.currentUserAvatar.textContent = (user.email && user.email[0].toUpperCase()) || '🙂';
        showApp();
        // Optionally load user's posts from Firestore here
      } else {
        console.log('No user');
        appState.currentUser = null;
        hideApp();
        openLoginModal();
      }
    });

    // Composer buttons: use event delegation
    document.querySelectorAll('.composer-btn').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        document.querySelectorAll('.composer-btn').forEach(b=>b.classList.remove('active'));
        e.currentTarget.classList.add('active');
      });
    });

    // Create post
    selectors.createPostBtn.addEventListener('click', ()=>{
      const raw = selectors.postContent.value.trim();
      if(!raw){ alert('Please enter some content for your post'); return; }
      const privacy = selectors.privacySelect.value;

      const newPost = {
        id: Date.now().toString(),
        content: raw,
        privacy,
        author: appState.currentUser?.email || 'Anonymous User',
        timestamp: new Date().toISOString(),
        likes: 0,
        comments: []
      };

      // persist locally and in Firestore (optional)
      appState.posts.unshift(newPost);
      renderPosts();
      selectors.postContent.value = '';

      // If you want to persist: uncomment the lines below
      // db.collection('posts').add({ ...newPost, createdAt: firebase.firestore.FieldValue.serverTimestamp() })
      //   .then(()=>console.log('Saved to firestore'))
      //   .catch(err=>console.warn(err));
    });

    // Rendering
    function formatDate(iso){
      const date = new Date(iso);
      const now = new Date();
      const diff = now - date;
      if(diff < 60000) return 'Just now';
      if(diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
      if(diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
      return date.toLocaleString();
    }

    function renderPosts(){
      const container = selectors.postsContainer;
      if(!appState.posts.length){
        container.innerHTML = `<div class="card" style="text-align:center;padding:40px"><h3 class="muted">No posts yet</h3><p class="muted">Share your first research insight above!</p></div>`;
        return;
      }

      // Use escaped content to avoid XSS
      container.innerHTML = appState.posts.map(post => {
        const safeContent = escapeHtml(post.content).replace(/\n/g, '<br>');
        const safeAuthor = escapeHtml(post.author);
        return `
          <div class="card post">
            <div class="post-header">
              <div class="user-avatar">👩‍🔬</div>
              <div>
                <div class="post-author">${safeAuthor}</div>
                <div class="post-time muted">${formatDate(post.timestamp)}</div>
              </div>
            </div>
            <div class="post-content" style="margin-top:8px">${safeContent}</div>
            <div class="post-actions">
              <button class="post-action" data-id="${post.id}" data-action="like">❤️ ${post.likes}</button>
              <button class="post-action" data-id="${post.id}" data-action="comment">💬 ${post.comments.length}</button>
              <button class="post-action" data-id="${post.id}" data-action="share">🔄 Share</button>
            </div>
          </div>
        `;
      }).join('');

      // Attach event handlers for actions (delegation)
      container.querySelectorAll('.post-action').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const id = e.currentTarget.dataset.id;
          const action = e.currentTarget.dataset.action;
          if(action === 'like'){
            const p = appState.posts.find(x=>x.id===id);
            if(p){ p.likes++; renderPosts(); }
          } else if(action === 'comment'){
            const text = prompt('Enter your comment:');
            if(text){
              const p = appState.posts.find(x=>x.id===id);
              if(p){ p.comments.push({ author: appState.currentUser?.email || 'Anonymous', content: text, timestamp: new Date().toISOString() }); renderPosts(); }
            }
          } else if(action === 'share'){
            alert('Post shared! (stub)');
          }
        });
      });
    }

    // Sample data
    function loadSampleData(){
      appState.posts = [
        { id:'1', content:'Excited to share our new research on transformer architectures! We achieved a 15% improvement in efficiency while maintaining accuracy. 🚀 #AI #Research', privacy:'public', author:'Dr. Sarah Chen', timestamp:new Date(Date.now()-3600000).toISOString(), likes:12, comments:[{author:'John Doe',content:'Fascinating work!',timestamp:new Date().toISOString()}] },
        { id:'2', content:'Looking for collaborators on a computer vision project involving medical imaging. DM if interested! #ComputerVision #Healthcare', privacy:'research', author:'Prof. Michael Rodriguez', timestamp:new Date(Date.now()-7200000).toISOString(), likes:8, comments:[] }
      ];
      renderPosts();
    }

    // Trending & suggested
    function updateTrendingTopics(){
      const topics = ['#MachineLearning','#NeurIPS2025','#ComputerVision','#NLP','#DeepLearning','#AIResearch'];
      document.getElementById('trendingTopics').innerHTML = topics.map(t=>`<div class="trending-topic">${t}</div>`).join('');
    }
    function updateSuggestedUsers(){
      const users = [{name:'Dr. Lisa Wang',field:'Computer Vision'},{name:'Prof. James Smith',field:'NLP'},{name:'Dr. Anna Kumar',field:'Robotics'}];
      document.getElementById('suggestedUsers').innerHTML = users.map(u=>`<div class="suggested-user"><div class="user-avatar">👤</div><div style="flex:1"><div>${escapeHtml(u.name)}</div><div class="muted">${escapeHtml(u.field)}</div></div><button class="btn">Follow</button></div>`).join('');
    }

    // Init
    document.addEventListener('DOMContentLoaded', ()=>{
      // restore theme
      if(localStorage.getItem('theme')==='light') document.body.classList.add('light-theme');
      updateTrendingTopics();
      updateSuggestedUsers();
      loadSampleData();
    });

  </script>
</body>
</html>
