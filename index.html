<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DeepNet Social - AI Research Community</title>
  <style>
    /* Reset and Base Styles */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #18191a; color: #e4e6ea; }
    
    /* Modal Styles */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal-content { background: #242526; border-radius: 12px; width: 400px; max-width: 90%; padding: 0; }
    .modal-header { padding: 20px; border-bottom: 1px solid #3e4042; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h2 { color: #1877f2; font-size: 24px; }
    .modal-close { background: none; border: none; color: #b0b3b8; font-size: 24px; cursor: pointer; padding: 4px; }
    .modal-close:hover { color: #e4e6ea; }
    .modal-body { padding: 20px; }
    
    /* Auth Tabs */
    .auth-tabs { display: flex; margin-bottom: 20px; background: #3a3b3c; border-radius: 8px; padding: 4px; }
    .auth-tab { flex: 1; background: none; border: none; padding: 12px; color: #b0b3b8; cursor: pointer; border-radius: 6px; font-weight: 600; transition: 0.2s; }
    .auth-tab.active { background: #1877f2; color: white; }
    
    /* Forms */
    .auth-form { display: block; }
    .auth-form.hidden { display: none; }
    .auth-form input { width: 100%; padding: 12px; margin-bottom: 12px; background: #3a3b3c; border: 1px solid #3e4042; border-radius: 6px; color: #e4e6ea; font-size: 14px; }
    .auth-form input:focus { outline: none; border-color: #1877f2; }
    .auth-form input::placeholder { color: #b0b3b8; }
    .btn { width: 100%; padding: 12px; background: #1877f2; border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; font-size: 14px; }
    .btn:hover { background: #166fe5; }
    
    /* Messages */
    #loginMessage, #signupMessage { margin-top: 12px; padding: 10px; border-radius: 6px; font-size: 14px; text-align: center; }
    .auth-message.success { background: rgba(24,119,242,0.2); color: #1877f2; }
    .auth-message.error { background: rgba(244,67,54,0.2); color: #f44336; }
    
    /* Layout */
    .hidden { display: none !important; }
    .header { background: #242526; padding: 16px; border-bottom: 1px solid #3e4042; position: sticky; top: 0; z-index: 100; }
    .header-content { display: flex; align-items: center; justify-content: space-between; max-width: 800px; margin: 0 auto; }
    .logo { font-size: 20px; font-weight: bold; color: #1877f2; }
    .feed { max-width: 600px; margin: 20px auto; padding: 0 16px; }
    .card { background: #242526; border-radius: 8px; padding: 16px; margin-bottom: 16px; border: 1px solid #3e4042; }
    
    /* Post Composer */
    .post-composer textarea { width: 100%; background: #3a3b3c; border: 1px solid #3e4042; border-radius: 8px; padding: 12px; color: #e4e6ea; font-size: 14px; resize: vertical; min-height: 80px; margin-bottom: 12px; }
    .post-composer textarea::placeholder { color: #b0b3b8; }
    .post-composer button { background: #1877f2; color: white; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; }
    
    /* Posts */
    .post { margin-bottom: 20px; }
    .post-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
    .user-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
    .post-content { margin: 12px 0; line-height: 1.4; }
    .post-stats { color: #b0b3b8; font-size: 13px; margin: 8px 0; }
    .post-actions { display: flex; gap: 12px; }
    .post-actions button { background: none; border: none; color: #b0b3b8; cursor: pointer; padding: 8px 12px; border-radius: 6px; transition: 0.2s; }
    .post-actions button:hover { background: #3a3b3c; }
    .post-actions button.liked { color: #1877f2; }
    
    /* Comments */
    .comments { margin-top: 12px; border-top: 1px solid #3e4042; padding-top: 8px; }
    .comment-list > div { margin-bottom: 8px; padding: 8px; background: #3a3b3c; border-radius: 6px; font-size: 13px; }
    .comment-input { width: 100%; background: #3a3b3c; border: 1px solid #3e4042; border-radius: 16px; padding: 8px 12px; color: #e4e6ea; font-size: 13px; margin-top: 8px; }
    
    /* Search */
    #searchInput { background: #3a3b3c; border: 1px solid #3e4042; border-radius: 20px; padding: 8px 16px; color: #e4e6ea; font-size: 14px; }
    
    /* Notification */
    .notification { position: fixed; top: 20px; right: 20px; background: #1877f2; color: white; padding: 12px 20px; border-radius: 8px; z-index: 1500; opacity: 0; transform: translateX(100%); transition: 0.3s; }
    .notification.show { opacity: 1; transform: translateX(0); }
    .notification.error { background: #e74c3c; }
  </style>
</head>
<body>
  <!-- Login Modal -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üß† DeepNet Social</h2>
        <button type="button" class="modal-close" onclick="closeLoginModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="auth-tabs">
          <button type="button" class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
          <button type="button" class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
        </div>
        
        <form id="loginForm" class="auth-form">
          <input type="email" name="email" placeholder="Enter email" required />
          <input type="password" name="password" placeholder="Enter password" required />
          <button type="submit" class="btn">Login</button>
          <div id="loginMessage"></div>
        </form>
        
        <form id="signupForm" class="auth-form hidden">
          <input type="email" name="email" placeholder="Enter email" required />
          <input type="password" name="password" placeholder="Create password" minlength="6" required />
          <button type="submit" class="btn">Sign Up</button>
          <div id="signupMessage"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div id="notification" class="notification"></div>

  <!-- Main App Layout -->
  <div id="app" class="hidden">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <div class="logo">üß† DeepNet Social</div>
        <input type="text" id="searchInput" placeholder="Search posts..." />
        <div>
          <span id="currentUserAvatar">üë©‚Äçüî¨</span>
          <button onclick="logoutUser()">Logout</button>
        </div>
      </div>
    </header>

    <!-- Feed -->
    <main class="feed">
      <!-- Composer -->
      <div class="post-composer card">
        <textarea id="postContent" placeholder="Share your research insights..."></textarea>
        <button onclick="createPost()">Post</button>
      </div>

      <!-- Posts -->
      <div id="postsContainer"></div>
    </main>
  </div>

  <!-- Firebase v9 Modular SDK -->
  <script type="module">
    // Import Firebase functions
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword, 
      onAuthStateChanged, 
      signOut, 
      sendEmailVerification 
    } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBytov9p2TGFudvnwQZ1hSi5f9oXaSKDAQ",
      authDomain: "deepnet-social-backend.firebaseapp.com",
      projectId: "deepnet-social-backend",
      storageBucket: "deepnet-social-backend.firebasestorage.app",
      messagingSenderId: "689173633913",
      appId: "1:689173633913:web:b5290dc64ea8fd2b2f2da8",
      measurementId: "G-B1ENWRY6JK"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // Storage helpers
    const STORAGE_KEY = "deepnet_posts";
    function getPosts(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY))||[]; } catch{ return []; } }
    function setPosts(p){ localStorage.setItem(STORAGE_KEY, JSON.stringify(p)); }

    // UI helpers
    function showNotification(message, type='success'){
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.classList.add('show');
      setTimeout(()=>notification.classList.remove('show'), 3000);
    }

    // Auth functions
    window.switchAuthTab = function(tab){
      document.getElementById('loginForm').classList.toggle('hidden', tab!=='login');
      document.getElementById('signupForm').classList.toggle('hidden', tab!=='signup');
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[onclick="switchAuthTab('${tab}')"]`).classList.add('active');
    }

    window.closeLoginModal = function(){ document.getElementById('loginModal').style.display='none'; }
    function openLoginModal(){ document.getElementById('loginModal').style.display='block'; }
    function showApp(){ document.getElementById('app').classList.remove('hidden'); closeLoginModal(); }

    // SIGNUP with email verification
    document.getElementById('signupForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = e.target.email.value.trim();
      const password = e.target.password.value.trim();
      const msg = document.getElementById('signupMessage');

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        await sendEmailVerification(cred.user);
        msg.className = 'auth-message success';
        msg.innerHTML = '‚úÖ Account created! Verification link sent to your email. Please verify and then log in.';
        await signOut(auth);
        e.target.reset();
      } catch (err) {
        msg.className = 'auth-message error';
        msg.textContent = `‚ùå ${err.message}`;
      }
    });

    // LOGIN with verification check
    document.getElementById('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = e.target.email.value.trim();
      const password = e.target.password.value.trim();
      const msg = document.getElementById('loginMessage');

      try {
        const cred = await signInWithEmailAndPassword(auth, email, password);

        if (!cred.user.emailVerified) {
          await signOut(auth);
          msg.className = 'auth-message error';
          msg.innerHTML = `
            ‚ùå Email not verified. Check your inbox/spam for the verification email.
            <br><br>
            <button id="resendBtn" style="margin-top:8px; padding:8px 12px; border:none; border-radius:6px; background:#1877f2; color:#fff; cursor:pointer;">
              Resend verification email
            </button>
          `;
          const resendBtn = document.getElementById('resendBtn');
          resendBtn.onclick = async () => {
            try {
              const temp = await signInWithEmailAndPassword(auth, email, password);
              await sendEmailVerification(temp.user);
              await signOut(auth);
              showNotification('Verification email sent again. Please check your inbox.');
            } catch (e2) {
              showNotification('Unable to resend: ' + e2.message, 'error');
            }
          };
          return;
        }

        msg.className = 'auth-message success';
        msg.textContent = '‚úÖ Login successful!';
        e.target.reset();
        setTimeout(showApp, 500);
      } catch (err) {
        msg.className = 'auth-message error';
        msg.textContent = `‚ùå ${err.message}`;
      }
    });

    // Auth state change - only verified users
    onAuthStateChanged(auth, (user)=>{
      if(user && user.emailVerified){ 
        showApp(); 
        document.getElementById('currentUserAvatar').textContent=user.email[0].toUpperCase(); 
        renderPosts(); 
      }
      else { 
        document.getElementById('app').classList.add('hidden'); 
        openLoginModal(); 
      }
    });

    window.logoutUser = async function(){ 
      try {
        await signOut(auth); 
        showNotification('Logged out successfully!');
      } catch (e) {
        showNotification('Logout failed: ' + e.message, 'error');
      }
    }

    // Posts functions
    function formatTime(t){ return new Date(t).toLocaleString(); }

    window.createPost = function(){
      const user=auth.currentUser; if(!user || !user.emailVerified) return showNotification("Please log in with verified email first!", "error");
      const content=document.getElementById('postContent').value.trim();
      if(!content) return;
      const newPost={
        id:Date.now().toString(),
        content,
        authorId:user.uid,
        authorName:user.email.split('@')[0],
        authorEmail:user.email,
        authorAvatar:`https://i.pravatar.cc/40?u=${user.uid}`,
        createdAt:new Date().toISOString(),
        likes:0, likedBy:[], commentList:[]
      };
      const posts=getPosts(); posts.unshift(newPost); setPosts(posts);
      document.getElementById('postContent').value='';
      renderPosts();
      showNotification('Post created! üéâ');
    }

    function renderPosts(){
      const posts=getPosts();
      const container=document.getElementById('postsContainer');
      container.innerHTML='';
      if(posts.length === 0){
        container.innerHTML = '<div class="card" style="text-align:center; color:#b0b3b8;">No posts yet. Be the first to share!</div>';
        return;
      }
      posts.forEach(p=>container.appendChild(createPostElement(p)));
    }

    function createPostElement(post){
      const div=document.createElement('div');
      div.className='card post'; div.dataset.postId=post.id;
      const isLiked=post.likedBy.includes(auth.currentUser?.uid);
      div.innerHTML=`
        <div class="post-header">
          <img src="${post.authorAvatar}" class="user-avatar" alt="${post.authorName}">
          <div><b>${post.authorName}</b> <small>${formatTime(post.createdAt)}</small></div>
        </div>
        <div class="post-content">${post.content.replace(/\n/g, '<br>')}</div>
        <div class="post-stats">
          <span>${post.likes} reactions ‚Ä¢ <span class="comment-count">${post.commentList.length}</span> comments</span>
        </div>
        <div class="post-actions">
          <button onclick="toggleLike('${post.id}')" class="${isLiked?'liked':''}">üëç Like</button>
          <button onclick="focusCommentInput('${post.id}')">üí¨ Comment</button>
        </div>
        <div class="comments">
          <div class="comment-list"></div>
          <input class="comment-input" placeholder="Write a comment..." onkeydown="commentKeydown(event,'${post.id}')">
        </div>`;
      renderComments(div,post);
      return div;
    }

    function renderComments(postEl, post){
      const list=postEl.querySelector('.comment-list'); list.innerHTML='';
      (post.commentList||[]).forEach((c,idx)=>{
        const item=document.createElement('div');
        item.innerHTML=`<b>${c.author}</b>: ${c.text.replace(/\n/g, '<br>')}
          ${auth.currentUser?.uid===c.userId?`<button onclick="deleteComment('${post.id}',${idx})" style="float:right; background:#e74c3c; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px;">Delete</button>`:''}`;
        list.appendChild(item);
      });
    }

    window.toggleLike = function(postId){
      const posts=getPosts(); const idx=posts.findIndex(p=>p.id===postId);
      if(idx===-1) return; const uid=auth.currentUser?.uid; if(!uid) return;
      const liked=posts[idx].likedBy.includes(uid);
      if(liked){ posts[idx].likedBy=posts[idx].likedBy.filter(x=>x!==uid); posts[idx].likes--; showNotification('Post unliked'); }
      else { posts[idx].likedBy.push(uid); posts[idx].likes++; showNotification('Post liked! üëç'); }
      setPosts(posts); renderPosts();
    }

    window.focusCommentInput = function(postId){
      document.querySelector(`[data-post-id="${postId}"] .comment-input`)?.focus();
    }

    window.commentKeydown = function(e,postId){
      if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); addComment(postId); }
    }

    window.addComment = function(postId){
      const posts=getPosts(); const idx=posts.findIndex(p=>p.id===postId); if(idx===-1) return;
      const input=document.querySelector(`[data-post-id="${postId}"] .comment-input`);
      const text=input.value.trim(); if(!text) return;
      const user=auth.currentUser; if(!user || !user.emailVerified) return showNotification("Please log in with verified email first!", "error");
      posts[idx].commentList.push({ userId:user.uid, author:user.email.split('@')[0], text, createdAt:new Date().toISOString() });
      setPosts(posts); renderPosts(); showNotification('Comment posted! üí¨');
    }

    window.deleteComment = function(postId,commentIndex){
      const posts=getPosts(); const idx=posts.findIndex(p=>p.id===postId); if(idx===-1) return;
      const comment=posts[idx].commentList[commentIndex];
      if(auth.currentUser?.uid!==comment.userId) return showNotification("Not allowed to delete this comment", "error");
      posts[idx].commentList.splice(commentIndex,1);
      setPosts(posts); renderPosts(); showNotification('Comment deleted');
    }

    // Search
    document.getElementById('searchInput').addEventListener('input', e=>{
      const q=e.target.value.toLowerCase();
      document.querySelectorAll('.post').forEach(p=>{
        p.style.display=p.innerText.toLowerCase().includes(q)?'block':'none';
      });
    });

    // Initialize
    console.log('üß† DeepNet Social with email verification loaded!');
  </script>
</body>
</html>
